# PiCast v1.0.0 Architecture Document

**Created:** 2026-02-26
**Status:** APPROVED (investigation complete, ready for plan mode)
**Sessions:** 5 planned

---

## Vision

PiCast v1.0.0 is the "hand it to anyone" release. A new user should be able to run
`install-pi.sh`, walk through optional setup prompts, and have a fully functional
YouTube queue player with autoplay, push notifications, and a rich web UI â€” all
without ever editing a config file or SSHing into the Pi.

---

## Session Plan Overview

| Session | Focus | Key Deliverables |
|---------|-------|------------------|
| S1 | PiPulse API + block metadata | New PiPulse endpoint, PiCast block metadata SQLite table, API client |
| S2 | Pool page enrichment + web block editor | Rich block cards, settings block editor, local schedule management |
| S3 | install-pi.sh overhaul | Interactive optional steps, post-install health check, config validation |
| S4 | picast-setup CLI + web setup hints | Standalone CLI wizard, settings page inline guides, Pushover/YouTube helpers |
| S5 | Integration testing + polish + tag | End-to-end test on Pi, edge cases, v1.0.0 git tag |

---

## Feature 1: Pool Page Block Metadata Enrichment

### Problem

Pool page block cards show raw names like `clean-mama` with no context about when
the block runs, what it's for, or any visual identity.

### Solution

Each block card shows: emoji + display name + time range + tagline + block type.

Example card:
```
ğŸ§¹ Clean Mama
12:00 PM - 3:00 PM | ritual
"Recovery is sacred"
4 videos Â· 2 liked
```

### Data Sources (Priority Order)

1. **PiPulse API** (when enabled) â€” live fetch from `GET /api/schedule/blocks`
2. **Local SQLite** (always) â€” user-managed via web UI block editor
3. **Raw block name** (fallback) â€” current behavior if neither configured

### PiPulse Integration Settings

Settings page toggle:
- **PiPulse Integration:** ON/OFF
- **PiPulse Host:** `10.0.0.103` (default)
- **PiPulse Port:** `5055` (default)
- When ON: pool page fetches `/api/schedule/blocks` from PiPulse (1-2s timeout)
- When OFF or unreachable: uses local SQLite block metadata
- Graceful fallback â€” never crashes, never shows error banners

### New PiPulse API Endpoint

**`GET /api/schedule/blocks`** â€” Returns merged block metadata from schedule.yaml + blocks.yaml.

Response format:
```json
{
  "blocks": {
    "clean-mama": {
      "display_name": "Clean Mama",
      "block_start": "12:00 PM",
      "emoji": "ğŸ§¹",
      "verb": "RESET",
      "tagline": "Recovery is sacred",
      "block_type": "ritual",
      "energy": "low",
      "keystone": "K5",
      "goal_tag": "HEALTH"
    },
    ...
  }
}
```

Data merged from:
- `schedule.yaml` â†’ display_name, block_start, fire_hour/minute, keystone, goal_tag
- `blocks.yaml` â†’ emoji, verb, tagline, block_type, energy, purpose

### New PiCast SQLite Table: `block_metadata`

```sql
CREATE TABLE IF NOT EXISTS block_metadata (
    block_name TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    block_start TEXT,      -- "12:00 PM"
    block_end TEXT,        -- "3:00 PM" (optional, derived from next block)
    emoji TEXT,            -- "ğŸ§¹"
    tagline TEXT,          -- "Recovery is sacred"
    block_type TEXT,       -- "ritual", "peak_creative", "execution", etc.
    energy TEXT,           -- "low", "medium", "high"
    source TEXT DEFAULT 'manual',  -- "manual", "pipulse_api", "import"
    updated_at TEXT
);
```

### Web UI Block Editor (Settings Page)

New "Autoplay Blocks" card in settings:
- Lists all blocks with editable fields
- "Add Block" button to create new blocks
- Each row: emoji picker (text input), display name, start time, tagline, type dropdown
- Save writes to `block_metadata` SQLite table
- "Import from PiPulse" button: one-click pull from API â†’ populates local table
- When PiPulse API is enabled, auto-refreshes local cache on each trigger

### Pool Page Block Card Rendering

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§¹ Clean Mama               â”‚
â”‚ 12:00 PM - 3:00 PM Â· ritual â”‚
â”‚ "Recovery is sacred"         â”‚
â”‚ 4 videos Â· 2 liked           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

API endpoint `GET /api/autoplay/pool` enriched to include block metadata:
1. Query `block_metadata` table for each block
2. If PiPulse integration ON and metadata is stale (>1h), background refresh
3. Merge metadata with pool stats
4. Return enriched response

---

## Feature 2: Pushover Token Auto-Setup

### Problem

Pushover requires API token + user key. Currently requires manual TOML editing.

### Solution: `picast-setup` CLI Wizard

Interactive command available post-install:

```
$ picast-setup

PiCast Setup Wizard
====================

1. Pushover Notifications (optional)
   Push notifications to your phone for SD card alerts and daily summaries.

   API Token: â–Œ (from https://pushover.net/apps/build)
   User Key:  â–Œ (from https://pushover.net/dashboard)

   [Testing...] âœ“ Notification sent! Check your phone.
   [Saved to ~/.config/picast/picast.toml]

2. YouTube Authentication (recommended)
   Required for age-restricted and some region-locked videos.

   Steps:
   a) Open Chromium on this Pi: chromium-browser youtube.com
   b) Sign into your YouTube/Google account
   c) Close Chromium

   [Detected: Chromium cookies available] âœ“
   [Saved cookie config to picast.toml]

3. PiPulse Integration (optional)
   Connect to PiPulse for rich autoplay block metadata.

   PiPulse Host: 10.0.0.103 â–Œ
   PiPulse Port: 5055 â–Œ

   [Testing...] âœ“ Connected! Found 10 schedule blocks.
   [Imported block metadata to local database]

Setup complete! Run: sudo systemctl restart picast
```

### Validation Logic

- **Pushover:** Send test notification via `requests.post("https://api.pushover.net/1/messages.json")`. If 200, tokens valid.
- **YouTube:** Check if `~/.config/chromium/` cookie jar exists and has youtube.com cookies.
- **PiPulse:** `GET http://{host}:{port}/api/health` with 2s timeout.

### Skipped Steps

If user skips a step:
- Config section left commented out (or `enabled = false`)
- Settings page shows inline hint: "Not configured. Run `picast-setup` or see guide below."

---

## Feature 3: install-pi.sh Overhaul

### Current State

Installs system deps, pip packages, creates config, sets up systemd. No interactive
setup, no Pushover, no YouTube auth guidance.

### New Structure

```bash
#!/bin/bash
# PiCast v1.0.0 Installer

# Phase 1: System (non-interactive)
- apt install mpv socat python3-pip chromium-browser
- pip install picast + yt-dlp
- mkdir ~/.picast, ~/.config/picast
- Generate default picast.toml (all optional features disabled)
- Setup systemd service + timer
- Configure mpv (mpv.conf)
- Add user to video group

# Phase 2: Optional Setup (interactive)
echo "Would you like to configure optional features now? (y/N)"
if yes:
    picast-setup  # Runs the same CLI wizard

# Phase 3: Post-Install Health Check
- Start service
- Wait 3s
- curl http://localhost:5050/api/health
- Print status summary:
  âœ“ PiCast v1.0.0 running on port 5050
  âœ“ mpv connected
  âš  Pushover: not configured (run picast-setup later)
  âš  YouTube auth: not configured (recommended)
  âœ“ Web UI: http://picast.local:5050
```

### Key Principles

- All optional steps are **skippable** â€” the app works without them
- `picast-setup` is a standalone command that can be run anytime
- Post-install health check gives immediate confidence
- Display rotation is NOT in install â€” it's in Settings web UI

---

## Feature 4: Settings Page Setup Hints

### Inline Guide Pattern

Each settings card that requires external setup gets a collapsed hint section:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”” Pushover Notifications      OFF  â”‚
â”‚                                      â”‚
â”‚ â–¸ Setup Guide                        â”‚
â”‚   1. Create app: pushover.net/apps   â”‚
â”‚   2. Copy API Token + User Key       â”‚
â”‚   3. SSH: picast-setup               â”‚
â”‚   Or edit ~/.config/picast/picast.tomlâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Cards with hints:
- **Pushover** â€” token setup steps + link to pushover.net
- **YouTube Auth** â€” chromium cookie steps
- **PiPulse Integration** â€” host/port config + test button
- **Autoplay Blocks** â€” block editor + "Import from PiPulse" button

---

## Database Schema Changes

### New Table: `block_metadata`

```sql
CREATE TABLE IF NOT EXISTS block_metadata (
    block_name TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    block_start TEXT,
    block_end TEXT,
    emoji TEXT,
    tagline TEXT,
    block_type TEXT,
    energy TEXT,
    source TEXT DEFAULT 'manual',
    updated_at TEXT
);
```

**Schema version:** Bump to v10 (current is v9).

### Migration

Standard PiCast migration pattern: check version, run CREATE TABLE, bump version.

---

## API Changes

### PiPulse (New)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/schedule/blocks` | GET | All block metadata merged from schedule.yaml + blocks.yaml |

### PiCast (Modified)

| Endpoint | Method | Change |
|----------|--------|--------|
| `/api/autoplay/pool` | GET | Enrich response with block metadata from SQLite |
| `/api/settings/blocks` | GET | List all block_metadata entries |
| `/api/settings/blocks` | POST | Create/update a block metadata entry |
| `/api/settings/blocks/<name>` | DELETE | Remove a block metadata entry |
| `/api/settings/blocks/import` | POST | Pull from PiPulse API and save locally |
| `/api/settings/pipulse` | GET | PiPulse integration config |
| `/api/settings/pipulse` | POST | Update PiPulse host/port/enabled |

### PiCast (New CLI)

| Command | Purpose |
|---------|---------|
| `picast-setup` | Interactive setup wizard (Pushover + YouTube + PiPulse) |

Entry point in `pyproject.toml [project.scripts]`.

---

## File Changes Summary

### PiPulse (S1 only)

| File | Change |
|------|--------|
| `src/pipulse/server/app.py` | Add `/api/schedule/blocks` endpoint |

### PiCast

| File | Change |
|------|--------|
| `src/picast/server/database.py` | Schema v10, `block_metadata` table, CRUD methods |
| `src/picast/server/app.py` | New settings API endpoints, enriched pool response |
| `src/picast/server/templates/pool.html` | Rich block cards with metadata |
| `src/picast/server/templates/settings.html` | Block editor card, PiPulse card, inline hints |
| `src/picast/server/static/style.css` | Block card styles, editor styles, hint styles |
| `src/picast/config.py` | PiPulse integration config fields |
| `src/picast/cli.py` | `picast-setup` entry point |
| `src/picast/setup_wizard.py` | New: interactive setup wizard logic |
| `install-pi.sh` | Overhaul: Phase 1/2/3 structure |
| `picast.toml.example` | Updated with all optional sections documented |
| `src/picast/__about__.py` | Version bumps per session |

---

## Session Breakdown (Detailed)

### S1: PiPulse API + PiCast Block Metadata Foundation

**PiPulse side:**
- Add `GET /api/schedule/blocks` endpoint
- Reads schedule.yaml + blocks.yaml, merges, returns JSON
- Deploy to Pi, verify endpoint

**PiCast side:**
- Schema v10: `block_metadata` table
- Database CRUD methods: get_all_block_metadata, upsert_block_metadata, delete_block_metadata
- PiPulse API client: fetch + parse block metadata
- Config: `pipulse_host`, `pipulse_port`, `pipulse_enabled` fields
- Settings API: GET/POST pipulse config, POST import from PiPulse

**Tests:** All new database methods, API client, config parsing

### S2: Pool Page Enrichment + Web Block Editor

**Pool page:**
- `GET /api/autoplay/pool` returns enriched blocks with metadata
- Block cards: emoji + display name + time + tagline + type + video stats
- Graceful fallback: raw block name if no metadata

**Settings page:**
- "Autoplay Blocks" card with block editor
- Add/edit/delete blocks via web form
- "Import from PiPulse" button
- PiPulse integration toggle + host/port

**Deploy + verify** on Pi

### S3: install-pi.sh Overhaul

- Phase 1: non-interactive system setup (modernized)
- Phase 2: optional `picast-setup` wizard call
- Phase 3: post-install health check with status summary
- Test on fresh Pi image (or verify script logic locally)

### S4: picast-setup CLI + Settings Hints

**CLI wizard:**
- Pushover: prompt, validate via API, write config
- YouTube: guide through chromium, detect cookies, write config
- PiPulse: prompt host/port, test connection, import blocks

**Settings page:**
- Inline setup hints on each card (collapsed by default)
- Show configured/not-configured status per feature

### S5: Integration Testing + Polish + Tag

- End-to-end test on Pi: fresh config â†’ setup wizard â†’ all features working
- Edge cases: PiPulse down, no Pushover, no YouTube auth
- Pool page with all metadata sources
- Version bump to v1.0.0
- Git tag `v1.0.0`
- Update CLAUDE.md, README

---

## Open Questions for Plan Mode

These should be resolved in S1 plan mode:

1. **Block end times:** PiPulse schedule.yaml only has `block_start`. End time = next block's start? Or leave blank?
2. **PiPulse API auth:** Should the endpoint require any auth token, or is LAN-only sufficient?
3. **Block editor emoji input:** Free-text input, or predefined emoji picker dropdown?
4. **Cache staleness:** How long before PiPulse-sourced metadata is considered stale? 1 hour? 24 hours?
5. **picast-setup idempotency:** Running it twice should update existing config, not duplicate entries?

---

## Dependencies

- PiPulse must be deployed with new endpoint before PiCast can fetch from it (S1)
- Schema v10 migration must be tested before pool page changes (S1 â†’ S2)
- picast-setup must exist before install-pi.sh can call it (S4 â†’ S3, or stub it)
  - **Resolution:** S3 creates install script that calls `picast-setup` if available, skips gracefully if not. S4 creates the actual wizard.

---

## Success Criteria

A user with:
- A Raspberry Pi with HDMI display
- A YouTube account
- (Optional) A Pushover account
- (Optional) PiPulse running on same network

...can run `install-pi.sh`, optionally configure everything through the wizard or web UI, and have a fully functional PiCast with rich autoplay blocks, push notifications, and YouTube auth â€” without editing any config files.
