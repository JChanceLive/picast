{% extends "base.html" %}
{% block title_suffix %} - Queue{% endblock %}

{% block content %}
<section class="now-playing" id="now-playing">
    <div class="np-idle" id="np-idle">
        <div class="idle-time" id="idle-time"></div>
        <div>Nothing playing</div>
        <div class="idle-hint" id="idle-hint">Add a URL to start</div>
    </div>
    <div class="np-active" id="np-active" style="display:none">
        <div class="np-top">
            <img id="np-thumb" class="np-thumb" src="" alt="" style="display:none">
            <div class="np-info">
                <div class="np-title" id="np-title"></div>
                <div class="np-url" id="np-url"></div>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <span class="np-time" id="np-time">0:00 / 0:00</span>
        </div>
        <div class="np-meta">
            <span id="np-volume">Vol: 100</span>
            <span id="np-speed">Speed: 1.0x</span>
            <span id="np-source" class="source-tag"></span>
        </div>
    </div>
</section>

<section class="controls" id="controls-section">
    <button class="btn-icon-pin" id="btn-pin" onclick="toggleFloatingControls()" title="Pin controls" aria-label="Pin controls">üìå</button>
    <div class="controls-bar">
        <button onclick="doToggle(this)" class="btn-icon" id="btn-toggle" aria-label="Pause"><span class="bi-ico">‚è∏</span><span class="bi-lbl">Pause</span></button>
        <button onclick="doSkip(this)" class="btn-icon" id="btn-skip" aria-label="Skip"><span class="bi-ico">‚è≠</span><span class="bi-lbl">Skip</span></button>
        <button onclick="doStop(this)" class="btn-icon btn-icon-danger" id="btn-stop" aria-label="Stop"><span class="bi-ico">‚èπ</span><span class="bi-lbl">Stop</span></button>
        <button onclick="volDown()" class="btn-icon" aria-label="Volume down"><span class="bi-ico">üîâ</span><span class="bi-lbl">Vol-</span></button>
        <button onclick="volUp()" class="btn-icon" aria-label="Volume up"><span class="bi-ico">üîä</span><span class="bi-lbl">Vol+</span></button>
        <button onclick="speedDown()" class="btn-icon" aria-label="Slow down"><span class="bi-ico">üêå</span><span class="bi-lbl">Slow</span></button>
        <button onclick="speedUp()" class="btn-icon" aria-label="Speed up"><span class="bi-ico">üêá</span><span class="bi-lbl">Fast</span></button>
        <button onclick="toggleStopAfter(this)" class="btn-icon" id="btn-stop-after" aria-label="Stop after current"><span class="bi-ico">‚è±</span><span class="bi-lbl">1More</span></button>
        <button onclick="setSleepTimer(30)" class="btn-icon" id="btn-sleep-30" aria-label="Sleep 30 minutes"><span class="bi-ico">üò¥</span><span class="bi-lbl">30m</span></button>
        <button onclick="handleSleep60()" class="btn-icon" id="btn-sleep-60" aria-label="Sleep 60 minutes"><span class="bi-ico">üò¥</span><span class="bi-lbl">60m</span></button>
        <button onclick="toggleLoop()" class="btn-icon" id="btn-loop" aria-label="Loop queue"><span class="bi-ico">üîÅ</span><span class="bi-lbl">Loop</span></button>
    </div>
    <div class="timer-status" id="timer-status" style="display:none">
        <span id="timer-countdown"></span>
    </div>
</section>

<section class="error-banner" id="error-banner">
    <div class="error-banner-header">
        <span class="error-banner-title" id="error-banner-title"></span>
        <button class="error-banner-dismiss" onclick="dismissError()" aria-label="Dismiss">&times;</button>
    </div>
    <div class="error-banner-detail" id="error-banner-detail"></div>
    <div class="error-banner-actions">
        <button class="btn btn-sm" id="error-banner-retry" onclick="retryErrorItem()">Retry</button>
        <button class="btn btn-sm" onclick="dismissError()">Dismiss</button>
    </div>
</section>

<section class="add-url">
    <form id="add-form" onsubmit="addUrl(event)">
        <input type="text" inputmode="url" id="url-input" placeholder="YouTube URL, video ID, or playlist..." autocomplete="off" oninput="detectPlaylist()">
        <div class="import-target" id="import-target" style="display:none">
            <span class="import-label">Import to:</span>
            <button type="button" class="btn btn-sm import-opt active" id="opt-queue" onclick="setImportTarget('queue')">Queue</button>
            <button type="button" class="btn btn-sm import-opt" id="opt-collection" onclick="setImportTarget('collection')">Collection</button>
        </div>
        <button type="submit" class="btn btn-primary" id="btn-add">Add to Queue</button>
    </form>
</section>

<section class="queue" id="queue-section">
    <h2>Queue (<span id="queue-count">0</span> pending)</h2>
    <input type="text" id="queue-search" class="queue-search" placeholder="Filter queue..." oninput="filterQueue(this.value)">
    <div id="queue-list"></div>
    <div class="queue-actions">
        <button onclick="clearPlayed()" class="btn btn-sm">Clear Played</button>
        <button onclick="clearAll()" class="btn btn-sm btn-danger">Clear All</button>
    </div>
</section>

<div class="discover-overlay" id="discover-overlay" onclick="if(event.target===this)closeDiscoverModal()">
    <div class="discover-modal">
        <div id="discover-form">
            <div class="discover-header">
                <h3>Discover Movies &#x1F3B2;</h3>
                <button class="discover-close" onclick="closeDiscoverModal()">&times;</button>
            </div>
            <div class="discover-body">
                <label class="discover-label">Search by title</label>
                <input type="text" id="discover-keyword" class="discover-input" placeholder="e.g. Dracula, Night of the..." autocomplete="off">
                <label class="discover-label">Genre</label>
                <select id="discover-genre" class="discover-select">
                    <option value="">Any Genre</option>
                    <option value="horror">Horror</option>
                    <option value="comedy">Comedy</option>
                    <option value="drama">Drama</option>
                    <option value="sci-fi">Sci-Fi</option>
                    <option value="thriller">Thriller</option>
                    <option value="western">Western</option>
                    <option value="mystery">Mystery</option>
                    <option value="romance">Romance</option>
                    <option value="adventure">Adventure</option>
                    <option value="action">Action</option>
                    <option value="animation">Animation</option>
                    <option value="documentary">Documentary</option>
                    <option value="war">War</option>
                    <option value="noir">Film Noir</option>
                    <option value="musical">Musical</option>
                    <option value="fantasy">Fantasy</option>
                </select>
                <label class="discover-label">Decade</label>
                <select id="discover-decade" class="discover-select">
                    <option value="">Any Decade</option>
                    <option value="1920s">1920s</option>
                    <option value="1930s">1930s</option>
                    <option value="1940s">1940s</option>
                    <option value="1950s">1950s</option>
                    <option value="1960s">1960s</option>
                    <option value="1970s">1970s</option>
                    <option value="1980s">1980s</option>
                    <option value="1990s">1990s</option>
                    <option value="2000s">2000s</option>
                    <option value="2010s">2010s</option>
                    <option value="2020s">2020s</option>
                </select>
                <label class="discover-label">Sort by</label>
                <select id="discover-sort" class="discover-select">
                    <option value="downloads">Most Popular</option>
                    <option value="date">Recently Added</option>
                    <option value="title">Title A-Z</option>
                </select>
            </div>
            <div class="discover-actions">
                <button class="btn" onclick="closeDiscoverModal()">Cancel</button>
                <button class="btn btn-primary" id="btn-roll" onclick="rollMovies()">Roll 10 Movies &#x1F3B2;</button>
            </div>
        </div>
        <div id="discover-loading" style="display:none">
            <div class="discover-loading-content">
                <div class="discover-spinner">&#x1F3B2;</div>
                <div class="discover-loading-title">Hang Tight!</div>
                <div class="discover-loading-sub">Rolling movies from Archive.org...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentVolume = 100;
let currentSpeed = 1.0;
let addingUrl = false;
let stopAfterCurrent = false;
let sleepTimerActive = false;
let isPlaylistUrl = false;
let importTarget = 'queue';
let loopEnabled = false;
let idleStreak = 0;

function poll() {
    fetch('/api/status')
        .then(r => r.json())
        .then(updateNowPlaying)
        .catch(() => {});
    fetch('/api/queue')
        .then(r => r.json())
        .then(updateQueue)
        .catch(() => {});
}

function ytThumb(url) {
    if (!url) return null;
    const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    return m ? 'https://img.youtube.com/vi/' + m[1] + '/mqdefault.jpg' : null;
}

function extractVideoId(url) {
    if (!url) return '';
    const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    return m ? m[1] : '';
}

function updateNowPlaying(s) {
    const idle = document.getElementById('np-idle');
    const active = document.getElementById('np-active');

    updateTimerUI(s);

    if (s.idle) {
        idleStreak++;
        if (idleStreak < 3) return;  // Debounce: wait for sustained idle to prevent flicker
        idle.style.display = '';
        active.style.display = 'none';
        const now = new Date();
        document.getElementById('idle-time').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const pendingCount = lastQueueItems.filter(i => i.status === 'pending').length;
        let hint = pendingCount > 0
            ? pendingCount + ' video' + (pendingCount !== 1 ? 's' : '') + ' in queue'
            : 'Add a URL to start';
        if (s.loop_enabled && s.loop_count > 0) hint += ' \u2022 Loop #' + s.loop_count;
        document.getElementById('idle-hint').textContent = hint;
        setToggleBtn(true);
        return;
    }
    idleStreak = 0;
    idle.style.display = 'none';
    active.style.display = '';

    const icon = s.paused ? '|| ' : '>> ';
    document.getElementById('np-title').textContent = icon + (s.title || s.url || '');
    document.getElementById('np-url').textContent = s.url || '';

    const thumb = document.getElementById('np-thumb');
    const thumbUrl = ytThumb(s.url);
    if (thumbUrl) {
        thumb.src = thumbUrl;
        thumb.style.display = '';
    } else {
        thumb.style.display = 'none';
    }

    const pct = s.duration > 0 ? (s.position / s.duration) * 100 : 0;
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('np-time').textContent = fmt(s.position) + ' / ' + fmt(s.duration);

    currentVolume = s.volume || 100;
    currentSpeed = s.speed || 1.0;
    document.getElementById('np-volume').textContent = 'Vol: ' + Math.round(currentVolume);
    document.getElementById('np-speed').textContent = 'Speed: ' + currentSpeed.toFixed(1) + 'x';

    const tags = {youtube: '[YT]', local: '[Local]', twitch: '[Twitch]'};
    document.getElementById('np-source').textContent = tags[s.source_type] || '';

    setToggleBtn(s.paused);
}

let lastQueueItems = [];

function updateQueue(items) {
    lastQueueItems = items;
    const pending = items.filter(i => i.status === 'pending').length;
    document.getElementById('queue-count').textContent = pending;

    const list = document.getElementById('queue-list');
    if (!items.length) {
        list.innerHTML = '<div class="queue-empty">Queue is empty</div>';
        return;
    }

    const pendingIds = items.filter(i => i.status === 'pending').map(i => i.id);
    const statusIcons = {pending: '', playing: '\u25B6', played: '\u2713', skipped: '\u2014', failed: '\u2717'};
    const tags = {youtube: 'YT', local: 'Local', twitch: 'Twitch'};

    list.innerHTML = items.map((item, i) => {
        const title = item.title || item.url;
        const isFinished = ['played','skipped','failed'].includes(item.status);
        const isFailed = item.status === 'failed';
        const isPending = item.status === 'pending';
        const cls = item.status === 'playing' ? 'queue-item playing' :
                    item.status === 'failed' ? 'queue-item failed' :
                    item.status === 'skipped' ? 'queue-item skipped' :
                    item.status === 'played' ? 'queue-item played' : 'queue-item';
        const videoId = extractVideoId(item.url);
        const isPlaying = item.status === 'playing';
        const playBtn = !isPlaying ?
            `<button onclick="playNow(${item.id})" class="qi-circle qi-play" title="Play now">\u25B6</button>` : '';
        const replayBtn = isFailed ?
            `<button onclick="retryFailed(${item.id}).then(poll)" class="qi-circle qi-play" title="Retry" style="color:var(--danger);border-color:rgba(255,42,109,0.4)">\u21BB</button>` :
            isFinished ?
            `<button onclick="replayItem(${item.id})" class="qi-circle qi-replay" title="Re-queue">\u21BB</button>` : '';
        const addUrl = '/add-to-collection?url=' + encodeURIComponent(item.url) + '&title=' + encodeURIComponent(item.title||'') + '&source_type=' + encodeURIComponent(item.source_type||'youtube');
        const pidx = pendingIds.indexOf(item.id);
        const isFirst = pidx === 0;
        const isLast = pidx === pendingIds.length - 1;
        const moveCol = isPending ? `<span class="qi-move-col">
            <button onclick="moveItem(${item.id},-1)" class="qi-circle qi-move" title="Move up"${isFirst ? ' disabled' : ''}>\u25B2</button>
            <button onclick="moveItem(${item.id},1)" class="qi-circle qi-move" title="Move down"${isLast ? ' disabled' : ''}>\u25BC</button>
        </span>` : '';
        const watchCount = item.watch_count || 0;
        const watchHtml = watchCount > 0 ? `<span class="qi-watch-count" title="${watchCount} plays">${watchCount}x</span>` : '';
        const vidIdHtml = videoId ? `<span class="qi-video-id">${videoId}</span>` : '';
        const thumbUrl = ytThumb(item.url);
        const thumbHtml = thumbUrl ? `<img class="qi-thumb" src="${thumbUrl}" alt="">` : '';
        return `<div class="${cls}">
            ${playBtn}
            ${replayBtn}
            ${moveCol}
            <span class="qi-status">${statusIcons[item.status] || ''}</span>
            ${thumbHtml}
            <div class="qi-info">
                <div class="qi-info-top">
                    <span class="qi-source">${tags[item.source_type] || ''}</span>
                    <span class="qi-title">${esc(title)}</span>
                </div>
                <div class="qi-url">${esc(item.url || '')}</div>
                ${isFailed && item.last_error ? `<div class="qi-error">${esc(item.last_error)}${item.error_count > 1 ? `<span class="qi-error-count">(${item.error_count}x)</span>` : ''}</div>` : ''}
            </div>
            ${vidIdHtml}${watchHtml}
            <span class="qi-actions">
                <a href="${addUrl}" class="qi-circle qi-add" title="Add to collection">+</a>
                <button onclick="removeItem(${item.id})" class="qi-circle qi-remove" title="Remove">\u00D7</button>
            </span>
        </div>`;
    }).join('');
}

function moveItem(id, direction) {
    const pendingIds = lastQueueItems.filter(i => i.status === 'pending').map(i => i.id);
    const idx = pendingIds.indexOf(id);
    if (idx < 0) return;
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= pendingIds.length) return;
    pendingIds.splice(idx, 1);
    pendingIds.splice(newIdx, 0, id);
    api('queue/reorder', {item_ids: pendingIds}).then(poll);
}

function playNow(id) {
    const item = lastQueueItems.find(i => i.id === id);
    if (!item) return;
    const btn = event && event.target.closest('button');
    if (btn) { btn.disabled = true; btn.textContent = '...'; }
    api('play', {url: item.url, title: item.title || ''})
        .then(() => { showToast('Playing now'); poll(); })
        .catch(() => showToast('Play failed'))
        .finally(() => { if (btn) { btn.disabled = false; btn.textContent = '\u25B6'; } });
}

function api(action, data) {
    return fetch('/api/' + action, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: data ? JSON.stringify(data) : undefined,
    }).then(r => r.json());
}

function detectPlaylist() {
    const url = document.getElementById('url-input').value.trim();
    const target = document.getElementById('import-target');
    isPlaylistUrl = url.includes('list=');
    target.style.display = isPlaylistUrl ? '' : 'none';
    updateImportButton();
}

function setImportTarget(t) {
    importTarget = t;
    document.getElementById('opt-queue').classList.toggle('active', t === 'queue');
    document.getElementById('opt-collection').classList.toggle('active', t === 'collection');
    updateImportButton();
}

function updateImportButton() {
    const btn = document.getElementById('btn-add');
    if (!isPlaylistUrl) {
        btn.textContent = 'Add to Queue';
    } else if (importTarget === 'collection') {
        btn.textContent = 'Import to Collection';
    } else {
        btn.textContent = 'Import to Queue';
    }
}

function addUrl(e) {
    e.preventDefault();
    if (addingUrl) return;

    const input = document.getElementById('url-input');
    const btn = document.getElementById('btn-add');
    const url = input.value.trim();
    if (!url) return;

    addingUrl = true;
    btn.disabled = true;

    if (isPlaylistUrl) {
        btn.textContent = 'Importing...';
        const endpoint = importTarget === 'collection' ? 'playlists/import-playlist' : 'queue/import-playlist';
        api(endpoint, {url})
            .then(r => {
                if (r.ok) {
                    input.value = '';
                    if (importTarget === 'collection') {
                        const msg = 'Created "' + (r.collection_name || 'Collection') + '" with ' + r.added + ' video' + (r.added !== 1 ? 's' : '');
                        showToast(msg);
                    } else {
                        const msg = 'Added ' + r.added + ' video' + (r.added !== 1 ? 's' : '') + ' to queue';
                        if (r.failed > 0) showToast(msg + ' (' + r.failed + ' failed)');
                        else showToast(msg);
                    }
                } else {
                    showToast(r.error || 'Import failed');
                }
                poll();
            })
            .catch(() => showToast('Import failed'))
            .finally(() => {
                addingUrl = false;
                isPlaylistUrl = false;
                document.getElementById('import-target').style.display = 'none';
                btn.textContent = 'Add to Queue';
                btn.disabled = false;
            });
    } else {
        btn.textContent = 'Adding...';
        api('queue/add', {url})
            .then(r => {
                if (r.error) {
                    showToast(r.error);
                } else {
                    input.value = '';
                    showToast('Added to queue');
                    poll();
                }
            })
            .catch(() => showToast('Failed to add'))
            .finally(() => {
                addingUrl = false;
                btn.textContent = 'Add to Queue';
                btn.disabled = false;
            });
    }
}

function replayItem(id) {
    const btn = event && event.target;
    if (btn) { btn.disabled = true; btn.textContent = '...'; }

    api('queue/replay', {id})
        .then(r => {
            if (r.ok) {
                showToast('Replaying');
            } else {
                const item = lastQueueItems.find(i => i.id === id);
                if (item) return api('queue/add', {url: item.url, title: item.title}).then(() => showToast('Re-added to queue'));
                showToast('Replay failed');
            }
        })
        .catch(() => showToast('Replay failed'))
        .finally(() => {
            if (btn) { btn.disabled = false; btn.textContent = '\u21BB'; }
            poll();
        });
}

function removeItem(id) {
    const btn = event && event.target;
    withLoading(btn, '...', fetch('/api/queue/' + id, {method:'DELETE'})
        .then(() => { showToast('Removed'); poll(); }));
}
function clearPlayed() {
    const btn = event && event.target;
    withLoading(btn, '...', api('queue/clear-played').then(() => { showToast('Cleared played'); poll(); }));
}
function clearAll() {
    const btn = event && event.target;
    withLoading(btn, '...', api('queue/clear').then(() => { showToast('Queue cleared'); poll(); }));
}

function doToggle(btn) {
    withLoading(btn, '...', api('toggle').then(() => poll()));
}
function doSkip(btn) {
    withLoading(btn, '...', api('skip').then(() => { showToast('Skipped'); poll(); }));
}
function doStop(btn) {
    withLoading(btn, '...', api('stop').then(() => { showToast('Stopped'); poll(); }));
}
function volUp() { currentVolume = Math.min(100, currentVolume + 5); api('volume', {level: currentVolume}); showToast('Vol: ' + Math.round(currentVolume)); }
function volDown() { currentVolume = Math.max(0, currentVolume - 5); api('volume', {level: currentVolume}); showToast('Vol: ' + Math.round(currentVolume)); }
function speedUp() { currentSpeed = Math.min(4, currentSpeed + 0.25); api('speed', {speed: currentSpeed}); showToast('Speed: ' + currentSpeed.toFixed(1) + 'x'); }
function speedDown() { currentSpeed = Math.max(0.25, currentSpeed - 0.25); api('speed', {speed: currentSpeed}); showToast('Speed: ' + currentSpeed.toFixed(1) + 'x'); }

function setToggleBtn(paused) {
    const btn = document.getElementById('btn-toggle');
    const ico = btn.querySelector('.bi-ico');
    const lbl = btn.querySelector('.bi-lbl');
    if (paused) { ico.textContent = '‚ñ∂'; lbl.textContent = 'Play'; }
    else { ico.textContent = '‚è∏'; lbl.textContent = 'Pause'; }
}

function fmt(s) {
    s = Math.max(0, Math.floor(s || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return h + ':' + String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
    return m + ':' + String(sec).padStart(2,'0');
}

// Timer controls
function toggleStopAfter(btn) {
    stopAfterCurrent = !stopAfterCurrent;
    api('timer/stop-after-current', {enabled: stopAfterCurrent})
        .then(() => { showToast(stopAfterCurrent ? 'Will stop after this video' : 'Continuous play'); });
}

function setSleepTimer(minutes) {
    api('timer/stop-in', {minutes})
        .then(() => {
            if (minutes > 0) showToast('Sleep timer: ' + minutes + ' min');
            else showToast('Sleep timer cancelled');
        });
}

function handleSleep60() {
    if (sleepTimerActive) {
        setSleepTimer(0);
    } else {
        setSleepTimer(60);
    }
}

function toggleLoop() {
    loopEnabled = !loopEnabled;
    api('queue/loop', {enabled: loopEnabled})
        .then(() => showToast(loopEnabled ? 'Queue loop ON' : 'Queue loop OFF'));
}

function updateTimerUI(s) {
    // Sync loop button state
    loopEnabled = s.loop_enabled || false;
    const loopBtn = document.getElementById('btn-loop');
    if (loopEnabled) loopBtn.classList.add('btn-icon-active');
    else loopBtn.classList.remove('btn-icon-active');

    stopAfterCurrent = s.stop_after_current || false;
    const btn = document.getElementById('btn-stop-after');
    if (stopAfterCurrent) {
        btn.classList.add('btn-icon-active');
        btn.title = 'Stopping after this video (click to cancel)';
    } else {
        btn.classList.remove('btn-icon-active');
        btn.title = 'Stop after this video';
    }

    const timerStatus = document.getElementById('timer-status');
    const countdown = document.getElementById('timer-countdown');
    const sleep60 = document.getElementById('btn-sleep-60');
    if (s.stop_timer_remaining != null && s.stop_timer_remaining > 0) {
        sleepTimerActive = true;
        countdown.textContent = 'Sleeping in ' + fmt(s.stop_timer_remaining);
        timerStatus.style.display = '';
        sleep60.querySelector('.bi-ico').textContent = '‚ùå';
        sleep60.querySelector('.bi-lbl').textContent = 'Off';
        sleep60.title = 'Cancel sleep timer';
    } else {
        sleepTimerActive = false;
        countdown.textContent = '';
        timerStatus.style.display = 'none';
        sleep60.querySelector('.bi-ico').textContent = 'üò¥';
        sleep60.querySelector('.bi-lbl').textContent = '60m';
        sleep60.title = 'Sleep 60 min';
    }
}

// Floating controls
function toggleFloatingControls() {
    const section = document.getElementById('controls-section');
    section.classList.toggle('floating');
    const isFloating = section.classList.contains('floating');
    localStorage.setItem('picast-floating-controls', isFloating ? '1' : '0');
    document.getElementById('btn-pin').classList.toggle('pinned', isFloating);
}

// Restore float state
(function() {
    if (localStorage.getItem('picast-floating-controls') === '1') {
        document.getElementById('controls-section').classList.add('floating');
        document.getElementById('btn-pin').classList.add('pinned');
    }
})();

function filterQueue(query) {
    const items = document.querySelectorAll('#queue-list .queue-item');
    const q = query.toLowerCase();
    items.forEach(item => {
        const title = (item.querySelector('.qi-title') || {}).textContent || '';
        item.style.display = !q || title.toLowerCase().includes(q) ? '' : 'none';
    });
}

// SSE event stream for real-time updates
let errorBannerTimeout = null;
let lastErrorItemId = null;

function connectSSE() {
    const es = new EventSource('/api/events');

    es.addEventListener('error', function(e) {
        try {
            const data = JSON.parse(e.data);
            showErrorBanner(data.title, data.detail, data.queue_item_id);
            poll();
        } catch (err) {}
    });

    es.addEventListener('failed', function(e) {
        try {
            const data = JSON.parse(e.data);
            showErrorBanner(data.title, data.detail, data.queue_item_id);
            poll();
        } catch (err) {}
    });

    es.addEventListener('playback', function(e) {
        poll();
    });

    es.addEventListener('retry', function(e) {
        poll();
    });

    es.addEventListener('protected', function(e) {
        try {
            const data = JSON.parse(e.data);
            showErrorBanner(data.title, data.detail, data.queue_item_id);
            poll();
        } catch (err) {}
    });

    es.onerror = function() {
        // SSE connection lost - polling is still running as fallback
        es.close();
        setTimeout(connectSSE, 5000);
    };
}

function showErrorBanner(title, detail, itemId) {
    const banner = document.getElementById('error-banner');
    document.getElementById('error-banner-title').textContent = title || 'Error';
    document.getElementById('error-banner-detail').textContent = detail || '';
    lastErrorItemId = itemId;
    const retryBtn = document.getElementById('error-banner-retry');
    retryBtn.style.display = itemId ? '' : 'none';
    banner.classList.add('visible');

    if (errorBannerTimeout) clearTimeout(errorBannerTimeout);
    errorBannerTimeout = setTimeout(dismissError, 15000);
}

function dismissError() {
    document.getElementById('error-banner').classList.remove('visible');
    if (errorBannerTimeout) { clearTimeout(errorBannerTimeout); errorBannerTimeout = null; }
}

function retryErrorItem() {
    if (lastErrorItemId) {
        retryFailed(lastErrorItemId).then(poll);
        dismissError();
    }
}

connectSSE();
setInterval(poll, 1000);
poll();

// Discover modal
function openDiscoverModal() {
    document.getElementById('discover-form').style.display = '';
    document.getElementById('discover-loading').style.display = 'none';
    document.getElementById('discover-overlay').classList.add('visible');
}

function closeDiscoverModal() {
    document.getElementById('discover-overlay').classList.remove('visible');
}

function rollMovies() {
    const genre = document.getElementById('discover-genre').value;
    const decade = document.getElementById('discover-decade').value;
    const keyword = document.getElementById('discover-keyword').value.trim();
    const sort = document.getElementById('discover-sort').value;

    // Switch to loading screen
    document.getElementById('discover-form').style.display = 'none';
    document.getElementById('discover-loading').style.display = '';

    fetch('/api/discover/roll', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({genre, decade, keyword, sort}),
    })
    .then(r => r.json())
    .then(r => {
        if (r.ok) {
            const count = r.added;
            showToast('Rolling ' + count + ' movie' + (count !== 1 ? 's' : '') + ' ‚Äî now playing!');
            closeDiscoverModal();
            poll();
        } else {
            showToast(r.error || 'No movies found');
            // Go back to form
            document.getElementById('discover-form').style.display = '';
            document.getElementById('discover-loading').style.display = 'none';
        }
    })
    .catch(() => {
        showToast('Roll failed ‚Äî try again');
        document.getElementById('discover-form').style.display = '';
        document.getElementById('discover-loading').style.display = 'none';
    });
}
</script>
{% endblock %}
