{% extends "base.html" %}
{% block title_suffix %} - Settings{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1rem;">Settings</h2>

<!-- Volume -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F50A;</span>
        <h3>Volume</h3>
    </div>
    <div class="settings-card-body">
        <div class="volume-control">
            <input type="range" id="volume-slider" class="settings-slider" min="0" max="100" value="0">
            <span class="volume-label" id="volume-label">--%</span>
        </div>
        <div class="settings-note" id="volume-note">Controls mpv playback volume</div>
    </div>
</div>

<!-- Display -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F5A5;</span>
        <h3>Display</h3>
    </div>
    <div class="settings-card-body">
        <div class="settings-row">
            <label for="rotation-select">Rotation</label>
            <select id="rotation-select" class="settings-select">
                <option value="0">Normal</option>
                <option value="2">Upside-down (180&deg;)</option>
            </select>
        </div>
        <div class="settings-note" id="display-note">Changes require a reboot to take effect</div>
        <button class="btn btn-sm" id="btn-save-rotation" onclick="saveRotation()">Apply &amp; Reboot</button>
    </div>
</div>

<!-- Player -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x25B6;</span>
        <h3>Player</h3>
    </div>
    <div class="settings-card-body">
        <div class="settings-row">
            <label>OSD Overlay</label>
            <button class="btn btn-sm" id="btn-osd" onclick="toggleOsd()">--</button>
        </div>
        <div class="settings-note">On-screen display (progress bar, volume indicator)</div>
    </div>
</div>

<!-- Pushover Notifications -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F514;</span>
        <h3>Pushover Notifications <span class="setup-status" id="pushover-status">...</span></h3>
    </div>
    <div class="settings-card-body">
        <div class="settings-note">SD card alerts and daily summaries to your phone</div>
        <details class="setup-hint">
            <summary>Setup Guide</summary>
            <div class="hint-body">
                1. Create an app at <a href="https://pushover.net/apps/build" target="_blank">pushover.net/apps</a><br>
                2. Copy your <strong>API Token</strong> and <strong>User Key</strong><br>
                3. Run via SSH: <code>picast-setup</code><br>
                4. Or edit <code>~/.config/picast/picast.toml</code>:<br>
                <code>[pushover]</code><br>
                <code>enabled = true</code><br>
                <code>api_token = "..."</code><br>
                <code>user_key = "..."</code>
            </div>
        </details>
    </div>
</div>

<!-- YouTube Authentication -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F3AC;</span>
        <h3>YouTube Auth <span class="setup-status" id="youtube-status">...</span></h3>
    </div>
    <div class="settings-card-body">
        <div class="settings-note" id="youtube-note">Required for age-restricted and region-locked videos</div>
        <details class="setup-hint">
            <summary>Setup Guide</summary>
            <div class="hint-body">
                <strong>Option 1: Browser cookies (recommended)</strong><br>
                1. Open Chromium on this Pi:<br>
                <code>chromium-browser youtube.com</code><br>
                2. Sign into your YouTube/Google account<br>
                3. Close Chromium<br>
                4. Run: <code>picast-setup</code><br><br>
                <strong>Option 2: PO token (headless)</strong><br>
                Set <code>ytdl_po_token</code> in <code>[server]</code> section of picast.toml
            </div>
        </details>
    </div>
</div>

<!-- PiPulse Integration -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F517;</span>
        <h3>PiPulse Integration <span class="setup-status" id="pipulse-status">...</span></h3>
    </div>
    <div class="settings-card-body">
        <div class="settings-row">
            <label>Enabled</label>
            <button class="btn btn-sm" id="btn-pipulse-toggle" onclick="togglePipulse()">--</button>
        </div>
        <div class="settings-row">
            <label for="pipulse-host">Host</label>
            <input type="text" id="pipulse-host" class="settings-select" style="width:auto" placeholder="10.0.0.103">
        </div>
        <div class="settings-row">
            <label for="pipulse-port">Port</label>
            <input type="number" id="pipulse-port" class="settings-select" style="width:5em" placeholder="5055">
        </div>
        <div class="settings-actions-row">
            <button class="btn btn-sm" onclick="savePipulseConfig()">Save</button>
        </div>
        <div class="settings-note" id="pipulse-note">Connect to PiPulse for rich block metadata</div>
        <details class="setup-hint">
            <summary>Setup Guide</summary>
            <div class="hint-body">
                PiPulse must be running on your network.<br>
                1. Default host: <code>10.0.0.103</code> port <code>5055</code><br>
                2. Enter host/port above and Save<br>
                3. Or run: <code>picast-setup</code>
            </div>
        </details>
    </div>
</div>

<!-- Autoplay Blocks -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F4C5;</span>
        <h3>Autoplay Blocks</h3>
    </div>
    <div class="settings-card-body">
        <div class="block-editor-list" id="block-editor-list">
            <div class="empty">Loading blocks...</div>
        </div>
        <div class="block-editor-form" id="block-form" style="display:none">
            <div class="block-editor-form-row">
                <label>Emoji</label>
                <input type="text" id="bf-emoji" class="bei-emoji-input" maxlength="4" placeholder="&#x1F3B5;">
                <label>Name</label>
                <input type="text" id="bf-block-name" placeholder="block-name">
            </div>
            <div class="block-editor-form-row">
                <label>Display</label>
                <input type="text" id="bf-display-name" placeholder="Display Name">
            </div>
            <div class="block-editor-form-row">
                <label>Start</label>
                <input type="text" id="bf-start" placeholder="6:30 AM">
                <label>End</label>
                <input type="text" id="bf-end" placeholder="8:00 AM">
            </div>
            <div class="block-editor-form-row">
                <label>Tagline</label>
                <input type="text" id="bf-tagline" placeholder="A short tagline...">
            </div>
            <div class="block-editor-form-row">
                <label>Type</label>
                <select id="bf-type">
                    <option value="">--</option>
                    <option value="peak_creative">peak_creative</option>
                    <option value="execution">execution</option>
                    <option value="ritual">ritual</option>
                    <option value="recovery">recovery</option>
                    <option value="wind_down">wind_down</option>
                    <option value="admin">admin</option>
                </select>
                <label>Energy</label>
                <select id="bf-energy">
                    <option value="">--</option>
                    <option value="high">high</option>
                    <option value="medium">medium</option>
                    <option value="low">low</option>
                </select>
            </div>
            <div class="block-editor-form-actions">
                <button class="btn btn-sm" onclick="cancelBlockForm()">Cancel</button>
                <button class="btn btn-sm btn-primary" id="bf-save-btn" onclick="saveBlock()">Save</button>
            </div>
        </div>
        <div class="settings-actions-row">
            <button class="btn btn-sm" onclick="showAddBlockForm()">Add Block</button>
            <button class="btn btn-sm" id="btn-import-blocks" onclick="importBlocks()">Import from PiPulse</button>
        </div>
    </div>
</div>

<!-- System Info -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x2139;</span>
        <h3>System Info</h3>
    </div>
    <div class="settings-card-body">
        <div class="sysinfo-grid" id="sysinfo-grid">
            <div class="sysinfo-loading">Loading...</div>
        </div>
    </div>
</div>

<!-- Service -->
<div class="settings-card">
    <div class="settings-card-header">
        <span class="settings-card-icon">&#x1F504;</span>
        <h3>Service</h3>
    </div>
    <div class="settings-card-body">
        <button class="btn btn-danger btn-sm" id="btn-restart" onclick="restartService()">Restart PiCast</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let volumeDebounce = null;

async function loadVolume() {
    try {
        const r = await fetch('/api/system/volume');
        const d = await r.json();
        const slider = document.getElementById('volume-slider');
        const label = document.getElementById('volume-label');
        if (d.error) {
            document.getElementById('volume-note').textContent = d.error;
            slider.disabled = true;
        } else {
            slider.value = d.volume;
            label.textContent = d.volume + '%';
        }
    } catch(e) {
        document.getElementById('volume-note').textContent = 'Failed to load volume';
    }
}

document.getElementById('volume-slider').addEventListener('input', function() {
    document.getElementById('volume-label').textContent = this.value + '%';
    clearTimeout(volumeDebounce);
    volumeDebounce = setTimeout(() => {
        fetch('/api/system/volume', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({volume: parseInt(this.value)})
        }).then(r => r.json()).then(d => {
            if (d.error) showToast('Volume error: ' + d.error);
        }).catch(() => showToast('Failed to set volume'));
    }, 200);
});

async function loadDisplay() {
    try {
        const r = await fetch('/api/system/display');
        const d = await r.json();
        const sel = document.getElementById('rotation-select');
        const note = document.getElementById('display-note');
        if (d.error) {
            note.textContent = d.error;
            sel.disabled = true;
            document.getElementById('btn-save-rotation').disabled = true;
        } else {
            sel.value = String(d.rotate);
        }
    } catch(e) {
        document.getElementById('display-note').textContent = 'Failed to load display settings';
    }
}

let rotationArmed = false;
function saveRotation() {
    const btn = document.getElementById('btn-save-rotation');
    const val = parseInt(document.getElementById('rotation-select').value);

    if (!rotationArmed) {
        rotationArmed = true;
        btn.textContent = 'Tap again to reboot';
        btn.className = 'btn btn-sm btn-danger';
        setTimeout(() => {
            if (rotationArmed) {
                rotationArmed = false;
                btn.textContent = 'Apply & Reboot';
                btn.className = 'btn btn-sm';
            }
        }, 4000);
        return;
    }
    rotationArmed = false;
    btn.disabled = true;
    btn.textContent = 'Saving...';
    fetch('/api/system/display', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({rotate: val})
    }).then(r => r.json()).then(d => {
        if (d.error) {
            showToast('Error: ' + d.error);
            btn.disabled = false;
            btn.textContent = 'Apply & Reboot';
            btn.className = 'btn btn-sm';
            return;
        }
        btn.textContent = 'Rebooting...';
        showToast('Rotation saved, rebooting...');
        fetch('/api/system/reboot', {method: 'POST'}).catch(() => {});
        setTimeout(() => location.reload(), 30000);
    }).catch(() => {
        showToast('Failed to save rotation');
        btn.disabled = false;
        btn.textContent = 'Apply & Reboot';
        btn.className = 'btn btn-sm';
    });
}

async function loadOsd() {
    try {
        const r = await fetch('/api/system/osd');
        const d = await r.json();
        document.getElementById('btn-osd').textContent = d.enabled ? 'Enabled' : 'Disabled';
        document.getElementById('btn-osd').className = 'btn btn-sm' + (d.enabled ? ' btn-icon-active' : '');
    } catch(e) {}
}

async function toggleOsd() {
    try {
        const r = await fetch('/api/system/osd', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const d = await r.json();
        document.getElementById('btn-osd').textContent = d.enabled ? 'Enabled' : 'Disabled';
        document.getElementById('btn-osd').className = 'btn btn-sm' + (d.enabled ? ' btn-icon-active' : '');
        showToast('OSD ' + (d.enabled ? 'enabled' : 'disabled'));
    } catch(e) {
        showToast('Failed to toggle OSD');
    }
}

async function loadSysinfo() {
    try {
        const r = await fetch('/api/system/info');
        const d = await r.json();
        const grid = document.getElementById('sysinfo-grid');
        let html = '';
        const items = [
            ['Version', d.version],
            ['Hostname', d.hostname],
            ['IP', d.ip],
            ['Uptime', d.uptime],
            ['CPU Temp', d.cpu_temp],
            ['Disk', d.disk],
            ['Audio', d.audio_device],
        ];
        for (const [label, val] of items) {
            if (val) {
                html += '<div class="sysinfo-item"><span class="sysinfo-label">' + esc(label) + '</span><span class="sysinfo-value">' + esc(val) + '</span></div>';
            }
        }
        grid.innerHTML = html || '<div class="sysinfo-loading">No info available</div>';
    } catch(e) {
        document.getElementById('sysinfo-grid').innerHTML = '<div class="sysinfo-loading">Failed to load</div>';
    }
}

let restartArmed = false;
function restartService() {
    const btn = document.getElementById('btn-restart');
    if (!restartArmed) {
        restartArmed = true;
        btn.textContent = 'Tap again to restart';
        setTimeout(() => {
            if (restartArmed) {
                restartArmed = false;
                btn.textContent = 'Restart PiCast';
            }
        }, 4000);
        return;
    }
    restartArmed = false;
    btn.disabled = true;
    btn.textContent = 'Restarting...';
    fetch('/api/system/restart', {method: 'POST'}).catch(() => {});
    showToast('Restarting service...');
    setTimeout(() => location.reload(), 5000);
}

// --- PiPulse Integration ---
async function loadPipulse() {
    try {
        const r = await fetch('/api/settings/pipulse');
        const d = await r.json();
        const btn = document.getElementById('btn-pipulse-toggle');
        btn.textContent = d.enabled ? 'Enabled' : 'Disabled';
        btn.className = 'btn btn-sm' + (d.enabled ? ' btn-icon-active' : '');
        document.getElementById('pipulse-host').value = d.host || '';
        document.getElementById('pipulse-port').value = d.port || '';
    } catch(e) {
        document.getElementById('pipulse-note').textContent = 'Failed to load PiPulse settings';
    }
}

async function togglePipulse() {
    const btn = document.getElementById('btn-pipulse-toggle');
    const isEnabled = btn.textContent === 'Enabled';
    try {
        await fetch('/api/settings/pipulse', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: !isEnabled})
        });
        btn.textContent = !isEnabled ? 'Enabled' : 'Disabled';
        btn.className = 'btn btn-sm' + (!isEnabled ? ' btn-icon-active' : '');
        showToast('PiPulse ' + (!isEnabled ? 'enabled' : 'disabled'));
    } catch(e) {
        showToast('Failed to toggle PiPulse');
    }
}

async function savePipulseConfig() {
    const host = document.getElementById('pipulse-host').value.trim();
    const port = parseInt(document.getElementById('pipulse-port').value) || 5055;
    try {
        await fetch('/api/settings/pipulse', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({host, port})
        });
        showToast('PiPulse config saved');
    } catch(e) {
        showToast('Failed to save PiPulse config');
    }
}

// --- Block Editor ---
let editingBlock = null;

async function loadBlockEditor() {
    try {
        const r = await fetch('/api/settings/blocks');
        const blocks = await r.json();
        const el = document.getElementById('block-editor-list');
        if (!blocks.length) {
            el.innerHTML = '<div class="empty">No blocks configured. Add manually or import from PiPulse.</div>';
            return;
        }
        el.innerHTML = blocks.map(b => {
            const meta = [];
            if (b.block_start) meta.push(b.block_start + (b.block_end ? ' - ' + b.block_end : ''));
            if (b.block_type) meta.push(b.block_type);
            if (b.energy) meta.push(b.energy + ' energy');
            return `<div class="block-editor-item">
                <span class="bei-emoji">${b.emoji || '&#x1F4E6;'}</span>
                <div class="bei-info">
                    <div class="bei-name">${esc(b.display_name || b.block_name)}</div>
                    <div class="bei-meta">${meta.length ? esc(meta.join(' &middot; ')) : esc(b.block_name)}</div>
                </div>
                <span class="bei-source">${esc(b.source || 'manual')}</span>
                <button class="qi-circle" onclick="editBlock('${esc(b.block_name)}')" title="Edit">&#x270E;</button>
                <button class="qi-circle qi-remove" onclick="deleteBlock('${esc(b.block_name)}')" title="Delete">&times;</button>
            </div>`;
        }).join('');
    } catch(e) {
        document.getElementById('block-editor-list').innerHTML = '<div class="empty">Failed to load blocks</div>';
    }
}

function showAddBlockForm() {
    editingBlock = null;
    document.getElementById('bf-block-name').value = '';
    document.getElementById('bf-block-name').disabled = false;
    document.getElementById('bf-display-name').value = '';
    document.getElementById('bf-emoji').value = '';
    document.getElementById('bf-start').value = '';
    document.getElementById('bf-end').value = '';
    document.getElementById('bf-tagline').value = '';
    document.getElementById('bf-type').value = '';
    document.getElementById('bf-energy').value = '';
    document.getElementById('bf-save-btn').textContent = 'Add';
    document.getElementById('block-form').style.display = '';
}

async function editBlock(blockName) {
    try {
        const r = await fetch('/api/settings/blocks');
        const blocks = await r.json();
        const b = blocks.find(x => x.block_name === blockName);
        if (!b) return;
        editingBlock = blockName;
        document.getElementById('bf-block-name').value = b.block_name;
        document.getElementById('bf-block-name').disabled = true;
        document.getElementById('bf-display-name').value = b.display_name || '';
        document.getElementById('bf-emoji').value = b.emoji || '';
        document.getElementById('bf-start').value = b.block_start || '';
        document.getElementById('bf-end').value = b.block_end || '';
        document.getElementById('bf-tagline').value = b.tagline || '';
        document.getElementById('bf-type').value = b.block_type || '';
        document.getElementById('bf-energy').value = b.energy || '';
        document.getElementById('bf-save-btn').textContent = 'Update';
        document.getElementById('block-form').style.display = '';
    } catch(e) {
        showToast('Failed to load block');
    }
}

function cancelBlockForm() {
    editingBlock = null;
    document.getElementById('block-form').style.display = 'none';
}

async function saveBlock() {
    const blockName = editingBlock || document.getElementById('bf-block-name').value.trim();
    if (!blockName) { showToast('Block name required'); return; }
    const data = {
        block_name: blockName,
        display_name: document.getElementById('bf-display-name').value.trim(),
        emoji: document.getElementById('bf-emoji').value.trim(),
        block_start: document.getElementById('bf-start').value.trim(),
        block_end: document.getElementById('bf-end').value.trim(),
        tagline: document.getElementById('bf-tagline').value.trim(),
        block_type: document.getElementById('bf-type').value,
        energy: document.getElementById('bf-energy').value,
    };
    try {
        const r = await fetch('/api/settings/blocks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const d = await r.json();
        if (d.ok) {
            showToast(editingBlock ? 'Block updated' : 'Block added');
            cancelBlockForm();
            loadBlockEditor();
        } else {
            showToast(d.error || 'Save failed');
        }
    } catch(e) {
        showToast('Failed to save block');
    }
}

async function deleteBlock(blockName) {
    try {
        const r = await fetch('/api/settings/blocks/' + encodeURIComponent(blockName), {method: 'DELETE'});
        const d = await r.json();
        if (d.ok) {
            showToast('Block deleted');
            loadBlockEditor();
        } else {
            showToast(d.error || 'Delete failed');
        }
    } catch(e) {
        showToast('Failed to delete block');
    }
}

async function importBlocks() {
    const btn = document.getElementById('btn-import-blocks');
    btn.disabled = true;
    btn.textContent = 'Importing...';
    try {
        const r = await fetch('/api/settings/blocks/import', {method: 'POST'});
        const d = await r.json();
        if (d.ok) {
            showToast('Imported ' + d.imported + ' blocks');
            loadBlockEditor();
        } else {
            showToast(d.error || 'Import failed');
        }
    } catch(e) {
        showToast('Import failed - check PiPulse connection');
    }
    btn.disabled = false;
    btn.textContent = 'Import from PiPulse';
}

// --- Setup Status ---
async function loadSetupStatus() {
    try {
        const r = await fetch('/api/settings/setup-status');
        const d = await r.json();
        const badge = (el, ok) => {
            el.textContent = ok ? 'Configured' : 'Not configured';
            el.className = 'setup-status ' + (ok ? 'configured' : 'not-configured');
        };
        badge(document.getElementById('pushover-status'), d.pushover.configured);
        badge(document.getElementById('pipulse-status'), d.pipulse.configured);
        const ytEl = document.getElementById('youtube-status');
        badge(ytEl, d.youtube.configured);
        if (d.youtube.configured && d.youtube.method) {
            document.getElementById('youtube-note').textContent =
                'Authenticated via ' + d.youtube.method;
        }
    } catch(e) {}
}

// Load all on page load
loadVolume();
loadDisplay();
loadOsd();
loadSysinfo();
loadPipulse();
loadBlockEditor();
loadSetupStatus();
</script>
{% endblock %}
